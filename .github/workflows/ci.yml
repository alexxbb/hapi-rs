name: CI

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always
  HFS: ""

jobs:
  check:
    name: Check
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: lib
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: lib
      
      - name: Run cargo check
        run: cargo check --all-features

  publish:
    name: Publish to crates.io
    needs: check
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment: release
    defaults:
      run:
        working-directory: lib
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: lib
      
      # Trusted Publishing (Recommended - requires setup on crates.io)
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1
        id: auth
      
      - name: Publish
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
      
      # Fallback: If not using Trusted Publishing, uncomment below and comment out above
      # - uses: katyo/publish-crates@v2
      #   with:
      #     path: './lib'
      #     registry-token: ${{ secrets.CRATES_TOKEN }}